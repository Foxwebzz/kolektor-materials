<div class="border p-4 rounded h-full overflow-auto border-gray-300">
  <input type="file" #fileInput accept=".pdf" class="hidden" (change)="onFileSelected($event)" />
  <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-300">
    <div>
      <img src="assets/kolektor.png" alt="" width="200px" style="margin-left: -12px" />
      <h3 class="text-lg">PREDKALKUKACIJA</h3>
    </div>
    <div class="flex items-end gap-4">
      <div class="flex flex-col gap-1">
        <label for="date" class="font-medium">Datum:</label>
        <p-datepicker [(ngModel)]="date" dateFormat="dd.mm.yy" inputId="date"></p-datepicker>
      </div>
    </div>
  </div>
  <div>
    <app-offer-form [(formData)]="formData"></app-offer-form>

    @if (selectedOptions().length > 0) {
    <p-table [value]="sortedOptions()" styleClass="p-datatable-sm">
      <ng-template #header>
        <tr>
          <th class="w-12">Poz.</th>
          <th>Naziv</th>
          <th class="text-right">Cena (€)</th>
          <th class="text-right">Kolicina</th>
          <th style="min-width: 80px">JM</th>
          <th class="text-right">Ukupna cena (€)</th>
          <th class="w-12"></th>
        </tr>
      </ng-template>
      <ng-template #body let-option let-i="rowIndex">
        @if (option.isGroupStart) {
        <tr>
          <td colspan="7" class="font-bold bg-gray-100">{{ option.displayTitle }}</td>
        </tr>
        }
        <tr>
          <td>{{ i + 1 }}.</td>
          <td>
            <input
              type="text"
              [ngModel]="option.name"
              (ngModelChange)="onNameChange(option.originalIndex, $event)"
              class="w-full rounded border border-gray-300 px-2 py-1 outline-none focus:border-blue-500"
            />
          </td>
          <td class="text-right">
            <p-inputnumber
              [ngModel]="option.price"
              (ngModelChange)="onPriceChange(option.originalIndex, $event)"
              [min]="0"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              inputStyleClass="w-32 text-right"
            ></p-inputnumber>
          </td>
          <td>
            <p-inputnumber
              [ngModel]="option.quantity"
              (ngModelChange)="onQuantityChange(option.originalIndex, $event)"
              [min]="0"
              [minFractionDigits]="0"
              [maxFractionDigits]="2"
              [showButtons]="true"
              buttonLayout="horizontal"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              inputStyleClass="w-20 text-right"
            ></p-inputnumber>
          </td>
          <td style="white-space: nowrap; overflow-wrap: normal">
            <input
              type="text"
              [ngModel]="option.unit"
              (ngModelChange)="onUnitChange(option.originalIndex, $event)"
              class="w-20 rounded border border-gray-300 px-2 py-1 outline-none focus:border-blue-500"
            />
          </td>
          <td class="text-right font-semibold">
            {{ option.price * option.quantity | number:'1.2-2' }}
          </td>
          <td>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [text]="true"
              [rounded]="true"
              (onClick)="onRemove(option.originalIndex)"
            ></p-button>
          </td>
        </tr>
      </ng-template>
      <ng-template #footer>
        <tr>
          <td colspan="5" class="text-right font-bold">UKUPNO:</td>
          <td class="text-right font-bold">{{ total | number:'1.2-2' }} €</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="5" class="text-right font-bold">
            Energetski dodatak ({{ energyPercent }}%):
          </td>
          <td class="text-right font-bold">{{ total * energyPercent / 100 | number:'1.2-2' }} €</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="5" class="text-right font-bold">
            Ukupna cena +
            <p-inputnumber
              [(ngModel)]="energyPercent"
              [min]="0"
              [max]="100"
              [minFractionDigits]="0"
              [maxFractionDigits]="2"
              suffix="%"
              inputStyleClass="w-16 text-right font-bold"
            ></p-inputnumber>
            energetski dodatak:
          </td>
          <td class="text-right font-bold">{{ totalWithEnergy | number:'1.2-2' }} €</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="5" class="text-right font-bold">
            Masa Transformatora:
            <p-inputnumber
              [(ngModel)]="transformerMass"
              [min]="0"
              [minFractionDigits]="0"
              [maxFractionDigits]="2"
              suffix=" kg"
              inputStyleClass="w-28 text-right font-bold"
            ></p-inputnumber>
          </td>
          <td class="text-right font-bold">
            @if (transformerMass) { ({{ totalWithEnergy / transformerMass | number:'1.2-2' }} €/kg)
            }
          </td>
          <td></td>
        </tr>
      </ng-template>
    </p-table>

    <div class="mt-4 flex justify-end gap-2">
      <p-button label="Sačuvaj u PDF" icon="pi pi-file-pdf" (onClick)="saveToPdf()"></p-button>
    </div>
    } @else {
    <div class="grid gap-4">
      <p class="text-gray-500">Izaberite opcije materijala za izradu vaše ponude</p>
      <p-button
        label="Uvezi PDF"
        icon="pi pi-upload"
        severity="secondary"
        (onClick)="triggerFileInput()"
      ></p-button>
    </div>
    }
  </div>
</div>
